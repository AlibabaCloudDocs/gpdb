# 客户端连接

云原生数据仓库PostgreSQL版完全兼容 PostgreSQL 消息协议，可以直接使用支持 PostgreSQL 消息协议的工具，例如命令行 psql、libpq、JDBC、ODBC、psycopg2等；图形化工具pgAdmin（注： ADB PG 4.3版本只支持 pgAdmin III 1.6.3及之前版本，ADB PG 6.0支持最新的pgAdmin 4版本），DBeaver，Navicat，阿里云 DMS 数据管理服务等也支持 AnalyticDB for PostgreSQL实例的管理和开发。

**说明：** AnalyticDB for PostgreSQL 4.3版本 基于 PostgreSQL 8.3 内核；AnalyticDB for PostgreSQL 6.0版本 基于 PostgreSQL 9.4内核。

## DMS 控制台

[数据管理](https://help.aliyun.com/document_detail/47550.html)（Data Management Service，简称DMS）支持MySQL、SQL Server、PostgreSQL、PPAS、Petadata等关系型数据库，DRDS等OLTP数据库，AnalyticDB、DLA等OLAP数据库和MongoDB、Redis等NoSQL的数据库管理。它是一种集数据管理、结构管理、用户授权、安全审计、数据趋势、数据追踪、BI图表、性能与优化和服务器管理于一体的数据管理服务。

本章节将为您介绍如何使用DMS登录云数据库 AnalyticDB for PostgreSQL。

1.  登录[AnalyticDB for PostgreSQL 控制台](https://gpdbnext.console.aliyun.com/gpdb/cn-hangzhou/list)。
2.  创建实例，具体操作请参见[创建实例](/cn.zh-CN/快速入门/创建实例.md)；若已完成创建操作，请单击目标实例ID进入实例详情页。
3.  创建账号，具体操作请参见[设置账号](/cn.zh-CN/快速入门/设置账号.md)。

    **说明：** 该账号用于登录DMS，每个实例只能创建一个。

4.  单击实例详情页右上角**登录数据库**。

    ![](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8629919951/p50990.png)

5.  在RDS数据库登录页面输入用户名和密码，单击**登录**。
6.  若有页面弹出如下提示，请根据当前情况选择相应设置。

    -   **设置所有实例：**当前用户下所有的实例都会被添加DMS的IP地址，以后不需要重复操作该步骤。
    -   **设置本实例：**只有当前登录的实例添加DMS的IP地址。
    -   **不设置：**不设置DMS的IP地址，该操作将无法使用DMS登录数据库。
    ![](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9629919951/p50991.png)


## 命令行 psql

psql 是 Greenplum 中比较常用的工具，提供了丰富的命令，其二进制文件在 Greenplum 安装后的 BIN 目录下。使用步骤如下所示：

1.  通过如下任意一种方式进行连接：

    -   连接串的方式

        ```
        psql "host=yourgpdbaddress.gpdb.rds.aliyuncs.com port=3432 dbname=postgres user=gpdbaccount password=gpdbpassword"
        ```

    -   指定参数的方式

        ```
        psql  -h yourgpdbaddress.gpdb.rds.aliyuncs.com -p 3432 -d postgres -U gpdbaccount
        ```

        参数说明：

        -   -h：指定主机地址。
        -   -p：指定端口号。
        -   -d：指定数据库（默认的数据库是 postgres），
        -   -U：指定连接的用户。
        -   可以通过`psql --help`查看更多选项。在 psql 中，可以执行`\?`查看更多 psql 中支持的命令。
2.  输入密码，进入 psql 的 Shell 界面。psql的Shell界面如下：

    ```
    postgres=>
    ```


**参考文档**

-   关于的 psql 的更多使用方法，可参见 Greenplum 社区文档[gp6 psql](http://docs.greenplum.org/6-4/utility_guide/ref/psql.html#topic1)。

-   ADB PG 也支持 PostgreSQL 的 psql 命令，使用时请注意细节上的差异。详情参见 PostgreSQL 社区文档“[PostgreSQL 8.3.23 Documentation — psql](https://www.postgresql.org/docs/8.3/static/app-psql.html)”。


**下载方式**

对于 RHEL（Red Hat Enterprise Linux）和 CentOS 版本 6 和 7 平台，可以通过以下地址进行下载，解压后即可使用：

-   ADBPG 4 客户端工具下载：

    -   RHEL 6 或 CentOS 6 平台，请单击 [ADBPG\_client\_package\_el6](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/43729/cn_zh/1491914418625/apsaradb_for_gp_client_package.redhat.el6.x86_64.tar.gz) 进行下载。

    -   RHEL 7 或 CentOS 7 平台，请单击 [ADBPG\_client\_package\_el7](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/43729/cn_zh/1491914523043/apsaradb_for_gp_client_package.redhat.el7.x86_64.tar.gz) 进行下载。

-   ADBPG 6 客户端工具下载：

    -   RHEL 6 或 CentOS 6 平台，请单击 [ADBPG\_client\_package\_el6](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/181125/cn_zh/1598426142282/adbpg_client_package.el6.x86_64.tar.gz) 进行下载。

    -   RHEL 7 或 CentOS 7 平台，请单击 [ADBPG\_client\_package\_el7](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/181125/cn_zh/1598426198114/adbpg_client_package.el7.x86_64.tar.gz) 进行下载。


**使用方式**

将客户端工具压缩包下载到本地后，以ADBPG 6 客户端工具CentOS 7 平台为例，其使用方式如下：

1.  在客户端工具压缩包目录下，对其解压：

    ```
    tar -xzvf adbpg_client_package.el7.x86_64.tar.gz
    ```

2.  解压后切换到bin目录下，执行命令：

    ```
    cd adbpg_client_package/bin
    ```

3.  bin目录下包括客户端工具psql、pg\_dump等，按照各工具参考文档，执行命令行。

    -   使用psql连接客户端的方式参考[命令行 psql](#section_nll_ssr_52b)。

    -   pg\_dump是PostgreSQL的逻辑备份工具，其使用方式可参考[命令行pg\_dump](https://gpdb.docs.pivotal.io/6-10/utility_guide/ref/pg_dump.html)。


另外, adbpg 也支持 docker 形态的工具包, 如下所示. 你可以在[这里](https://www.docker.com/get-started)找到对应平台 docker 安装地址.

```
# 运行对应于 adbpg 4.x 版本的工具镜像.
docker run -idt --name=adbpgcli aliadbpg/adbpgcli:v4.3.0  
docker exec -it adbpgcli /bin/bash -l

# 运行对应于 adbpg 6.x 版本的工具镜像.
docker run -idt --name=adbpgcli aliadbpg/adbpgcli:v6.3.0
docker exec -it adbpgcli /bin/bash -l
[root@adbpgcli /]# psql --help
```

## pgAdmin

pgAdmin 是 PostgreSQL 图形客户端，可以直接用于连接 AnalyticDB for PostgreSQL。详情参见 [官网](https://www.pgadmin.org/)。AnalyticDB for PostgreSQL 4.3版本基于 PostgreSQL 8.3 版本内核，因此必须使用 pgAdmin III 1.6.3 或之前的版本才能连AnalyticDB for PostgreSQL 4.3（pgAdmin 4 当前不支持）。AnalyticDB for PostgreSQL 6.0 版本基于 PostgreSQL 9.4版本，支持最新的 pgAdmin 4。

您可以从PostgreSQL官网下载 [pgAdmin III 1.6.3](https://www.postgresql.org/ftp/pgadmin/pgadmin3/v1.6.3/) 或[pgAdmin 4](https://www.pgadmin.org/docs/pgadmin4/1.x/) 。pgAdmin 支持各种平台，例如 Windows、MacOS 和 Linux。其它图形客户端，详情参见 [图形客户端工具](#graphy_client)。

**操作步骤**

1.  下载安装支持的 pgAdmin 版本。

2.  选择**文件** \> **新增服务器**，进入配置连接窗口。

3.  填写配置信息，如下图所示：

    ![](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/43729/cn_zh/1486448524740/pgadmin-connect-snapshot.png)

4.  单击**确定**，即可连接到 AnalyticDB for PostgreSQL。


## JDBC

用户需要使用 PostgreSQL 官方提供的JDBC。下载方法如下：

-   单击 [这里](https://jdbc.postgresql.org/)，下载 PostgreSQL 的官方 JDBC，下载之后加入到环境变量中。

-   也可采用 Greenplum 官网提供的工具包，详情请参见“[Greenplum Database 4.3 Connectivity Tools for UNIX](http://gpdb.docs.pivotal.io/43330/client_tool_guides/drivers/unix/unix_connect.html)”或"[Greenplum 6.3 Greenplum Client](https://gpdb.docs.pivotal.io/6-3/client_tool_guides/intro.html)"。


**代码示例**

```
import java.sql.Connection;  
import java.sql.DriverManager;  
import java.sql.ResultSet;  
import java.sql.SQLException;  
import java.sql.Statement;  
public class gp_conn {  
    public static void main(String[] args) {  
        try {  
            Class.forName("org.postgresql.Driver");  
            Connection db = DriverManager.getConnection("jdbc:postgresql://mygpdbpub.gpdb.rds.aliyuncs.com:3432/postgres","mygpdb","mygpdb");  
            Statement st = db.createStatement();  
            ResultSet rs = st.executeQuery("select * from gp_segment_configuration;");  
            while (rs.next()) {  
                System.out.print(rs.getString(1));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(2));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(3));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(4));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(5));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(6));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(7));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(8));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(9));  
                System.out.print("    |    ");  
                System.out.print(rs.getString(10));  
                System.out.print("    |    ");  
                System.out.println(rs.getString(11));  
            }  
            rs.close();  
            st.close();  
        } catch (ClassNotFoundException e) {  
            e.printStackTrace();  
        } catch (SQLException e) {  
            e.printStackTrace();  
        }  
    }  
}
```

详细文档，请参见“[The PostgreSQL JDBC Interface](https://jdbc.postgresql.org/documentation/94/index.html)”。

## Python

Python 连接 Greenplum 和 PostgreSQL 采用的库是 psycopg2。使用步骤如下：

1.  安装 psycopg2。在 CentOS 下，有如下三种安装方法：

    -   执行如下命令：`yum -y install python-psycopg2`
    -   执行如下命令：`pip install psycopg2`
    -   从源码安装：

        ```
        yum install -y postgresql-devel*
        wget  http://initd.org/psycopg/tarballs/PSYCOPG-2-6/psycopg2-2.6.tar.gz
        tar xf psycopg2-2.6.tar.gz
        cd psycopg2-2.6
        python setup.py build
        sudo python setup.py install
        ```

2.  安装后，设置 PYTHONPATH 环境变量，之后就可以引用，如下所示：

    ```
     import psycopg2
     sql = 'select * from gp_segment_configuration;'
     conn = psycopg2.connect(database='gpdb', user='mygpdb', password='mygpdb', host='mygpdbpub.gpdb.rds.aliyuncs.com', port=3432)
     conn.autocommit = True
     cursor = conn.cursor()
     cursor.execute(sql)
     rows = cursor.fetchall()
     for row in rows:
         print row
     conn.commit()
     conn.close()
    ```

    会得到类似以下的结果：

    ```
    (1, -1, 'p', 'p', 's', 'u', 3022, '192.168.2.158', '192.168.2.158', None, None)
    (6, -1, 'm', 'm', 's', 'u', 3019, '192.168.2.47', '192.168.2.47', None, None)
    (2, 0, 'p', 'p', 's', 'u', 3025, '192.168.2.148', '192.168.2.148', 3525, None)
    (4, 0, 'm', 'm', 's', 'u', 3024, '192.168.2.158', '192.168.2.158', 3524, None)
    (3, 1, 'p', 'p', 's', 'u', 3023, '192.168.2.158', '192.168.2.158', 3523, None)
    (5, 1, 'm', 'm', 's', 'u', 3026, '192.168.2.148', '192.168.2.148', 3526, None)
    ```


## libpq

libpq 是 PostgreSQL 数据库的 C 语言接口，用户可在 C 程序中通过 libpq 库访问 PostgreSQL 数据库并进行数据库操作。在安装了 Greenplum 或者 PostgreSQL 之后，在其 lib 目录下可以找到其静态库和动态库。

相关案例请参见 [这里](http://www.postgresql.org/docs/8.3/static/libpq-example.html)，此处不再列举。

关于 libpq 详情，请参见“[PostgreSQL 9.4.10 Documentation — Chapter 31. libpq - C Library](http://www.postgresql.org/docs/9.4/static/libpq.html)”。

## ODBC

PostgreSQL 的 ODBC 是基于 LGPL（GNU Lesser General Public License）协议的开源版本，可以在 [PostgreSQL 官网](https://odbc.postgresql.org/)下载。

**操作步骤**

1.  安装驱动。

    ```
    yum install -y unixODBC.x86_64  
    yum install -y postgresql-odbc.x86_64
    ```

2.  查看驱动配置。

    ```
    cat /etc/odbcinst.ini 
    # Example driver definitions
    # Driver from the postgresql-odbc package
    # Setup from the unixODBC package
    [PostgreSQL]
    Description     = ODBC for PostgreSQL
    Driver          = /usr/lib/psqlodbcw.so
    Setup           = /usr/lib/libodbcpsqlS.so
    Driver64        = /usr/lib64/psqlodbcw.so
    Setup64         = /usr/lib64/libodbcpsqlS.so
    FileUsage       = 1
    # Driver from the mysql-connector-odbc package
    # Setup from the unixODBC package
    [MySQL]
    Description     = ODBC for MySQL
    Driver          = /usr/lib/libmyodbc5.so
    Setup           = /usr/lib/libodbcmyS.so
    Driver64        = /usr/lib64/libmyodbc5.so
    Setup64         = /usr/lib64/libodbcmyS.so
    FileUsage       = 1
    ```

3.  配置 DSN，将如下代码中的`****`改成对应的连接信息。

    ```
    [mygpdb]
    Description = Test to gp
    Driver = PostgreSQL
    Database = ****
    Servername = ****.gpdb.rds.aliyuncs.com
    UserName = ****
    Password = ****
    Port = ****
    ReadOnly = 0
    ```

4.  测试连通性。

    ```
    echo "select count(*) from pg_class" | isql mygpdb
    +---------------------------------------+
    | Connected!                            |
    |                                       |
    | sql-statement                         |
    | help [tablename]                      |
    | quit                                  |
    |                                       |
    +---------------------------------------+
    SQL> select count(*) from pg_class
    +---------------------+
    | count               |
    +---------------------+
    | 388                 |
    +---------------------+
    SQLRowCount returns 1
    1 rows fetched
    ```

5.  ODBC 已连接上实例，将应用连接 ODBC 即可，具体操作请参见 [这里](https://odbc.postgresql.org/) 和 [C\# 连接到 PostgreSQL](https://odbc.postgresql.org/howto-csharp.html)。


## 其他参考信息

**图形客户端工具**

AnalyticDB for PostgreSQL 用户可以直接使用 Greenplum 支持的其它图形化客户端工具，包括

-   [pgadmin III \(1.6.3\)](https://www.postgresql.org/ftp/pgadmin/pgadmin3/v1.6.3/)
-   [pgAdmin 4](https://www.pgadmin.org/)
-   [dbeaver](https://dbeaver.io/)
-   [Navicat Premium](https://www.navicat.com/download/navicat-premium)
-   [Navicat For PostgreSQL](https://www.navicat.com/download/navicat-for-postgresql)
-   [SQL Workbench](http://www.sql-workbench.net/)

**Greenplum 客户端参考**

Greenplum 官网也提供了一个安装包，包含 JDBC、ODBC 和 libpq，用户可方便地安装和使用，详情参见[Greenplum 官方文档](http://gpdb.docs.pivotal.io/43330/client_tool_guides/drivers/unix/unix_connect.html)。

## 参考文档

-   [Greenplum 4.3 文档](http://gpdb.docs.pivotal.io/43330/common/welcome.html)

-   [Greenplum 6.0文档](https://gpdb.docs.pivotal.io/6-3/main/index.html)

-   [PostgreSQL psqlODBC](https://odbc.postgresql.org/)

-   [PostgreSQL ODBC 编译](https://odbc.postgresql.org/docs/unix-compilation.html)

-   [Greenplum ODBC 下载](https://www.progress.com/odbc/pivotal-greenplum)

-   [Greenplum JDBC 下载](https://www.progress.com/jdbc/pivotal-greenplum)


