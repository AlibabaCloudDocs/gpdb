# 表分布策略 {#concept_320755 .concept}

## 选择表分布策略 {#section_vns_kwe_eja .section}

`CREATE TABLE`的子句`DISTRIBUTED BY`和`DISTRIBUTED RANDOMLY`指定一个表的分布策略。默认是使用PRIMARY KEY（如果表有主键）或者表的第一个列作为分布键的哈希分布策略。如果一个表没有符合要求的列，会以随机或者循环方式分布行。

为确保数据的均匀分布，应该选择对每个记录都唯一的分布键。如果不符合，您可以选择DISTRIBUTED RANDOMLY。

**示例：**

示例中的建表语句创建了一个Hash分布的表。

``` {#codeblock_v23_lcn_0nt}
CREATE TABLE products (name varchar(40),
                         prod_id integer,
                         supplier_id integer)
             DISTRIBUTED BY (prod_id);                
```

示例中的建表语句创建了一个随机分布的表。

``` {#codeblock_hx9_upl_f6z}
CREATE TABLE random_stuff (things text,
                         doodads text,
                         etc text)
             DISTRIBUTED RANDOMLY;
```

AnalyticDB forPostgreSQL查询具有裁剪功能，例如products表使用prod\_id作为分布键，以下查询只会被发送到满足prod\_id=101的segment上执行：

``` {#codeblock_8sd_m7v_9c4}
select * from products where prod_id = 101;
```

## 表分布键选择原则 {#section_s0e_197_qgg .section}

-   若未指定分布键，默认表的主键为分布键，若表没有主键，则默认将第一列当做分布键。
-   分布键可以被定义为一个或多个列。例如：

    ``` {#codeblock_vdb_09q_evg}
    create table t1(c1 int, c2 int) distributed by (c1,c2);
    ```

-   分布键的列不能被更新（UPDATE）。
-   主键和唯一键必须包含分布键。例如：

    ``` {#codeblock_apq_hqx_rdm}
    create table t1(c1 int, c2 int, primary key (c1)) distributed by (c2);
    ```

    **说明：** 由于主键c1不包含分布键c2，所以建表语句返回失败。

    ``` {#codeblock_aub_6pa_lr4}
    ERROR: PRIMARY KEY and DISTRIBUTED BY definitions incompatible
    ```

-   Geometry类型和用户自定义数据类型不能作为分布键。
-   尽量选择数据分布均匀的列或者多个列：若选择的分布列数值分布不均匀，则可能导致数据倾斜。某些Segment分区节点存储数据多\(查询负载高\)。根据木桶原理，时间消耗会卡在数据多的节点上。故不应选择bool类型数据作为分布键。
-   尽量选择经常需要JOIN的列作为分布键：当关联键和分布键一致时，可以在 Segment分区节点内部完成JOIN，不需要重分布或者广播小表；当关联键和分布键不一致时，则需要重分布不一致的表或者广播小表，带来较大的额外开销。
-   尽量选择高并发查询的条件列作为分布键，从而支持做分区裁剪。
-   谨慎选择随机分布DISTRIBUTED RANDOMLY。

## 数据倾斜检查和处理 {#section_87d_68a_5z7 .section}

当某些表上的查询性能差时，可以查看是否是分区键设置不合理造成了数据倾斜，例如：

``` {#codeblock_ra6_syc_g4z}
create table t1(c1 int, c2 int) distributed by (c1);
```

您可以通过下述语句来查看表的数据倾斜情况。

``` {#codeblock_gv9_f22_yyw}
select gp_segment_id,count(1) from  t1 group by 1 order by 2 desc;
 gp_segment_id | count  
---------------+--------
             2 | 131191
             0 |     72
             1 |     68
(3 rows)
```

如果发现某些segment上存储的数据明显多于其他segment，该表存在数据倾斜。建议选取数据分布平均的列作为分布列，比如通过`ALTER TABLE`命令更改C2为分布键。

``` {#codeblock_xd2_p16_yve}
alter table t1 set distributed by (c2);
```

表t1的分布键被改为c2，该表的数据按照c2被重新分布，数据不再倾斜。

